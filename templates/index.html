<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmokeSense Pro - AI Health Analysis</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .header h1 {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
            font-weight: 300;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .form-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .analysis-card {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            max-height: 600px;
            overflow-y: auto;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .input-group {
            position: relative;
        }

        .input-label {
            display: block;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 6px;
            font-size: 0.9rem;
        }

        .input-hint {
            font-size: 0.75rem;
            color: #718096;
            margin-bottom: 6px;
            font-style: italic;
        }

        .input-field {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            background: #fff;
        }

        .input-field:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .predict-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 15px;
        }

        .predict-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .predict-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        .sample-btn {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            border: 2px solid rgba(102, 126, 234, 0.2);
            padding: 10px 20px;
            border-radius: 8px;
            margin: 0 5px 10px 0;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .sample-btn:hover {
            background: rgba(102, 126, 234, 0.2);
            transform: translateY(-1px);
        }

        .result-card {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            padding: 25px;
            border-radius: 16px;
            text-align: center;
            margin: 20px 0;
            box-shadow: 0 15px 30px rgba(72, 187, 120, 0.3);
        }

        .result-card.smoker {
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
            box-shadow: 0 15px 30px rgba(245, 101, 101, 0.3);
        }

        .result-title {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .result-probability {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .analysis-section {
            margin-bottom: 25px;
        }

        .analysis-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .health-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .metric-card {
            background: #f7fafc;
            padding: 15px;
            border-radius: 12px;
            border-left: 4px solid;
        }

        .metric-card.excellent { border-left-color: #48bb78; }
        .metric-card.good { border-left-color: #38a169; }
        .metric-card.fair { border-left-color: #ed8936; }
        .metric-card.poor { border-left-color: #f56565; }

        .metric-name {
            font-weight: 600;
            color: #2d3748;
            font-size: 0.9rem;
        }

        .metric-value {
            font-size: 1.1rem;
            font-weight: 700;
            margin: 5px 0;
        }

        .metric-status {
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .excellent { color: #48bb78; }
        .good { color: #38a169; }
        .fair { color: #ed8936; }
        .poor { color: #f56565; }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin: 15px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .recommendations {
            background: #f7fafc;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
        }

        .recommendation-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 12px;
            padding: 10px;
            background: white;
            border-radius: 8px;
        }

        .recommendation-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .icon-excellent { background: #48bb78; }
        .icon-warning { background: #ed8936; }
        .icon-danger { background: #f56565; }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #fed7d7;
            color: #c53030;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #f56565;
        }

        .success-message {
            background: #c6f6d5;
            color: #276749;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #48bb78;
        }

        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            .analysis-card {
                max-height: none;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .form-card, .analysis-card {
                padding: 25px;
            }
            
            .header h1 {
                font-size: 2.2rem;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
        }

.app-footer {
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
            color: white;
            text-align: center;
            padding: 20px 0;
            margin-top: 50px;
        }

        .footer-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .footer-container p {
            margin: 0;
            font-size: 0.9rem;
            color: #cbd5e0;
        }

        .footer-container strong {
            color: #667eea;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .header-container {
                flex-direction: column;
                gap: 15px;
            }
            
            .header-nav {
                gap: 20px;
            }
            
            .nav-link {
                font-size: 0.9rem;
            }
        }

    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>SmokeSense Pro</h1>
            <p>AI-Powered Health Analysis & Smoking Status Prediction</p>
        </div>

        <div class="main-grid">
            <!-- Input Form -->
            <div class="form-card">
                <h2 style="margin-bottom: 20px; color: #2d3748;">Health Data Input</h2>
                
                <form id="healthForm">
                    <div class="form-grid">
                        <div class="input-group">
                            <label class="input-label">Age</label>
                            <div class="input-hint">20-80 years</div>
                            <input type="number" class="input-field" name="age" min="18" max="120" step="1" required>
                        </div>

                        <div class="input-group">
                            <label class="input-label">Height (cm)</label>
                            <div class="input-hint">150-200 cm</div>
                            <input type="number" class="input-field" name="height" min="100" max="250" step="0.1" required>
                        </div>

                        <div class="input-group">
                            <label class="input-label">Weight (kg)</label>
                            <div class="input-hint">40-150 kg</div>
                            <input type="number" class="input-field" name="weight" min="30" max="200" step="0.1" required>
                        </div>

                        <div class="input-group">
                            <label class="input-label">Waist (cm)</label>
                            <div class="input-hint">60-120 cm</div>
                            <input type="number" class="input-field" name="waist" min="40" max="150" step="0.1" required>
                        </div>

                        <div class="input-group">
                            <label class="input-label">Systolic BP</label>
                            <div class="input-hint">90-180 mmHg</div>
                            <input type="number" class="input-field" name="systolic" min="60" max="250" step="1" required>
                        </div>

                        <div class="input-group">
                            <label class="input-label">Diastolic BP</label>
                            <div class="input-hint">60-120 mmHg</div>
                            <input type="number" class="input-field" name="diastolic" min="40" max="150" step="1" required>
                        </div>

                        <div class="input-group">
                            <label class="input-label">Blood Sugar</label>
                            <div class="input-hint">70-200 mg/dL</div>
                            <input type="number" class="input-field" name="fasting_blood_sugar" min="40" max="400" step="1" required>
                        </div>

                        <div class="input-group">
                            <label class="input-label">Cholesterol</label>
                            <div class="input-hint">120-300 mg/dL</div>
                            <input type="number" class="input-field" name="cholesterol" min="80" max="500" step="1" required>
                        </div>

                        <div class="input-group">
                            <label class="input-label">HDL</label>
                            <div class="input-hint">30-100 mg/dL</div>
                            <input type="number" class="input-field" name="hdl" min="15" max="150" step="1" required>
                        </div>

                        <div class="input-group">
                            <label class="input-label">LDL</label>
                            <div class="input-hint">60-200 mg/dL</div>
                            <input type="number" class="input-field" name="ldl" min="30" max="350" step="1" required>
                        </div>

                        <div class="input-group">
                            <label class="input-label">AST</label>
                            <div class="input-hint">10-60 U/L</div>
                            <input type="number" class="input-field" name="ast" min="5" max="200" step="1" required>
                        </div>

                        <div class="input-group">
                            <label class="input-label">ALT</label>
                            <div class="input-hint">10-60 U/L</div>
                            <input type="number" class="input-field" name="alt" min="5" max="200" step="1" required>
                        </div>
                    </div>

                    <button type="submit" class="predict-btn">Analyze Health Data</button>
                    
                    <div>
                        <button type="button" class="sample-btn" onclick="fillSampleData('healthy')">Healthy Sample</button>
                        <button type="button" class="sample-btn" onclick="fillSampleData('risk')">At-Risk Sample</button>
                        <button type="button" class="sample-btn" onclick="clearForm()">Clear Form</button>
                    </div>
                </form>

                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>Analyzing your health data...</p>
                </div>

                <div id="errorMessage" style="display: none;"></div>
            </div>

            <!-- Analysis Results -->
            <div class="analysis-card">
                <div id="analysisContent">
                    <div style="text-align: center; color: #718096; padding: 40px 20px;">
                        <h3>Health Analysis</h3>
                        <p>Enter your health data to see detailed analysis and recommendations</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

 <footer class="app-footer">
        <div class="footer-container">
            <p>&copy; 2025 All rights reserved by <strong>Shrikant Wadkar</strong></p>
        </div>
    </footer>
    

    <script>
        // Health analysis logic
        class HealthAnalyzer {
            constructor() {
                this.charts = {};
            }

            analyzeHealth(data) {
                const metrics = this.calculateMetrics(data);
                const recommendations = this.generateRecommendations(metrics);
                
                return {
                    metrics,
                    recommendations,
                    overallScore: this.calculateOverallScore(metrics)
                };
            }

            calculateMetrics(data) {
                const metrics = {};

                // BMI Analysis
                const bmi = data.weight / ((data.height / 100) ** 2);
                metrics.bmi = {
                    value: bmi.toFixed(1),
                    status: this.getBMIStatus(bmi),
                    range: "18.5-24.9 (Normal)"
                };

                // Blood Pressure Analysis
                metrics.bloodPressure = {
                    value: `${data.systolic}/${data.diastolic}`,
                    status: this.getBPStatus(data.systolic, data.diastolic),
                    range: "<120/80 (Normal)"
                };

                // Blood Sugar Analysis
                metrics.bloodSugar = {
                    value: data.fasting_blood_sugar,
                    status: this.getBloodSugarStatus(data.fasting_blood_sugar),
                    range: "70-100 mg/dL (Normal)"
                };

                // Cholesterol Analysis
                metrics.cholesterol = {
                    value: data.cholesterol,
                    status: this.getCholesterolStatus(data.cholesterol),
                    range: "<200 mg/dL (Desirable)"
                };

                // HDL Analysis
                metrics.hdl = {
                    value: data.hdl,
                    status: this.getHDLStatus(data.hdl),
                    range: ">40 mg/dL (Good)"
                };

                // LDL Analysis
                metrics.ldl = {
                    value: data.ldl,
                    status: this.getLDLStatus(data.ldl),
                    range: "<100 mg/dL (Optimal)"
                };

                // Liver Enzymes
                metrics.ast = {
                    value: data.ast,
                    status: this.getLiverEnzymeStatus(data.ast, 'AST'),
                    range: "10-40 U/L (Normal)"
                };

                metrics.alt = {
                    value: data.alt,
                    status: this.getLiverEnzymeStatus(data.alt, 'ALT'),
                    range: "7-56 U/L (Normal)"
                };

                return metrics;
            }

            getBMIStatus(bmi) {
                if (bmi < 18.5) return 'poor';
                if (bmi <= 24.9) return 'excellent';
                if (bmi <= 29.9) return 'fair';
                return 'poor';
            }

            getBPStatus(systolic, diastolic) {
                if (systolic < 120 && diastolic < 80) return 'excellent';
                if (systolic <= 129 && diastolic < 80) return 'good';
                if (systolic <= 139 || diastolic <= 89) return 'fair';
                return 'poor';
            }

            getBloodSugarStatus(sugar) {
                if (sugar <= 100) return 'excellent';
                if (sugar <= 125) return 'fair';
                return 'poor';
            }

            getCholesterolStatus(chol) {
                if (chol < 200) return 'excellent';
                if (chol <= 239) return 'fair';
                return 'poor';
            }

            getHDLStatus(hdl) {
                if (hdl >= 60) return 'excellent';
                if (hdl >= 40) return 'good';
                return 'poor';
            }

            getLDLStatus(ldl) {
                if (ldl < 100) return 'excellent';
                if (ldl <= 129) return 'good';
                if (ldl <= 159) return 'fair';
                return 'poor';
            }

            getLiverEnzymeStatus(value, type) {
                const normal = type === 'AST' ? 40 : 56;
                if (value <= normal) return 'excellent';
                if (value <= normal * 1.5) return 'fair';
                return 'poor';
            }

            calculateOverallScore(metrics) {
                const statusPoints = { excellent: 4, good: 3, fair: 2, poor: 1 };
                const scores = Object.values(metrics).map(m => statusPoints[m.status] || 1);
                const average = scores.reduce((a, b) => a + b, 0) / scores.length;
                
                if (average >= 3.5) return 'excellent';
                if (average >= 2.5) return 'good';
                if (average >= 1.5) return 'fair';
                return 'poor';
            }

            generateRecommendations(metrics) {
                const recommendations = [];

                if (metrics.bmi.status === 'poor') {
                    recommendations.push({
                        type: 'warning',
                        text: 'Consider weight management through balanced diet and regular exercise'
                    });
                }

                if (metrics.bloodPressure.status === 'poor' || metrics.bloodPressure.status === 'fair') {
                    recommendations.push({
                        type: 'danger',
                        text: 'Monitor blood pressure regularly and consider lifestyle changes'
                    });
                }

                if (metrics.bloodSugar.status === 'poor') {
                    recommendations.push({
                        type: 'danger',
                        text: 'Consult healthcare provider about blood sugar levels'
                    });
                }

                if (metrics.cholesterol.status === 'poor') {
                    recommendations.push({
                        type: 'warning',
                        text: 'Consider heart-healthy diet and regular cardio exercise'
                    });
                }

                if (metrics.hdl.status === 'poor') {
                    recommendations.push({
                        type: 'warning',
                        text: 'Focus on increasing HDL through exercise and healthy fats'
                    });
                }

                if (metrics.ast.status === 'poor' || metrics.alt.status === 'poor') {
                    recommendations.push({
                        type: 'danger',
                        text: 'Elevated liver enzymes - consider reducing alcohol and consulting doctor'
                    });
                }

                if (recommendations.length === 0) {
                    recommendations.push({
                        type: 'excellent',
                        text: 'Great job! Maintain your healthy lifestyle'
                    });
                }

                return recommendations;
            }

            renderAnalysis(analysis, smokingResult) {
                const content = document.getElementById('analysisContent');
                
                content.innerHTML = `
                    <div class="analysis-section">
                        <div class="analysis-title">
                            <span>🎯</span> Overall Health Score
                        </div>
                        <div class="metric-card ${analysis.overallScore}">
                            <div class="metric-name">Health Status</div>
                            <div class="metric-value ${analysis.overallScore}">${analysis.overallScore.toUpperCase()}</div>
                        </div>
                    </div>

                    ${smokingResult ? `
                    <div class="result-card ${smokingResult.is_smoker ? 'smoker' : ''}">
                        <div class="result-title">${smokingResult.prediction}</div>
                        <div class="result-probability">Probability: ${(smokingResult.probability * 100).toFixed(1)}%</div>
                    </div>
                    ` : ''}

                    <div class="analysis-section">
                        <div class="analysis-title">
                            <span>📊</span> Health Metrics
                        </div>
                        <div class="health-metrics">
                            ${Object.entries(analysis.metrics).map(([key, metric]) => `
                                <div class="metric-card ${metric.status}">
                                    <div class="metric-name">${this.getMetricDisplayName(key)}</div>
                                    <div class="metric-value">${metric.value}</div>
                                    <div class="metric-status ${metric.status}">${metric.status}</div>
                                    <div style="font-size: 0.75rem; color: #718096; margin-top: 5px;">
                                        Normal: ${metric.range}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div class="chart-container">
                        <canvas id="healthChart" width="400" height="200"></canvas>
                    </div>

                    <div class="analysis-section">
                        <div class="analysis-title">
                            <span>💡</span> Recommendations
                        </div>
                        <div class="recommendations">
                            ${analysis.recommendations.map(rec => `
                                <div class="recommendation-item">
                                    <div class="recommendation-icon icon-${rec.type}"></div>
                                    <div>${rec.text}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                `;

                this.createHealthChart(analysis.metrics);
            }

            getMetricDisplayName(key) {
                const names = {
                    bmi: 'BMI',
                    bloodPressure: 'Blood Pressure',
                    bloodSugar: 'Blood Sugar',
                    cholesterol: 'Total Cholesterol',
                    hdl: 'HDL Cholesterol',
                    ldl: 'LDL Cholesterol',
                    ast: 'AST (Liver)',
                    alt: 'ALT (Liver)'
                };
                return names[key] || key;
            }

            createHealthChart(metrics) {
                const ctx = document.getElementById('healthChart');
                if (!ctx) return;

                const statusValues = { excellent: 4, good: 3, fair: 2, poor: 1 };
                const colors = { excellent: '#48bb78', good: '#38a169', fair: '#ed8936', poor: '#f56565' };
                
                const labels = Object.keys(metrics).map(key => this.getMetricDisplayName(key));
                const values = Object.values(metrics).map(m => statusValues[m.status]);
                const backgroundColors = Object.values(metrics).map(m => colors[m.status]);

                if (this.charts.healthChart) {
                    this.charts.healthChart.destroy();
                }

                this.charts.healthChart = new Chart(ctx, {
                    type: 'radar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Health Status',
                            data: values,
                            backgroundColor: 'rgba(102, 126, 234, 0.2)',
                            borderColor: '#667eea',
                            borderWidth: 2,
                            pointBackgroundColor: backgroundColors,
                            pointBorderColor: backgroundColors,
                            pointRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            r: {
                                beginAtZero: true,
                                max: 4,
                                ticks: {
                                    stepSize: 1,
                                    callback: function(value) {
                                        const labels = ['', 'Poor', 'Fair', 'Good', 'Excellent'];
                                        return labels[value] || '';
                                    }
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            }
        }

        // Initialize analyzer
        const analyzer = new HealthAnalyzer();

        // Form handling
        document.getElementById('healthForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const data = {};
            
            // Add missing fields with default values
            const allFields = [
                'age', 'height', 'weight', 'waist', 'eyesight_left', 'eyesight_right',
                'hearing_left', 'hearing_right', 'systolic', 'diastolic', 'fasting_blood_sugar',
                'cholesterol', 'triglyceride', 'hdl', 'ldl', 'hemoglobin',
                'urine_protein', 'serum_creatinine', 'ast', 'alt', 'gtp'
            ];
            
            allFields.forEach(field => {
                if (formData.has(field)) {
                    data[field] = parseFloat(formData.get(field));
                } else {
                    // Set reasonable defaults for missing fields
                    const defaults = {
                        eyesight_left: 1.0, eyesight_right: 1.0,
                        hearing_left: 0, hearing_right: 0,
                        triglyceride: 150, hemoglobin: 14,
                        urine_protein: 0, serum_creatinine: 1.0, gtp: 30
                    };
                    data[field] = defaults[field] || 0;
                }
            });

            // Show loading state
            document.getElementById('loading').style.display = 'block';
            const submitBtn = document.querySelector('.predict-btn');
            submitBtn.disabled = true;
            hideMessage();

            try {
                // Try to get smoking prediction from API first
                let smokingResult = null;
                try {
                    smokingResult = await getSmokingPrediction(data);
                } catch (apiError) {
                    console.log('API prediction failed, using fallback:', apiError);
                    smokingResult = await simulateSmokingPrediction(data);
                }
                
// Perform health analysis
                const healthAnalysis = analyzer.analyzeHealth(data);
                
                // Display results
                analyzer.renderAnalysis(healthAnalysis, smokingResult);
                
                showMessage('Analysis completed successfully!', 'success');
                
            } catch (error) {
                console.error('Analysis error:', error);
                showMessage('Error performing analysis. Please try again.', 'error');
            } finally {
                // Hide loading state
                document.getElementById('loading').style.display = 'none';
                submitBtn.disabled = false;
            }
        });

        // API prediction function
        async function getSmokingPrediction(data) {
            const response = await fetch('/api/predict', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            return await response.json();
        }

        // Fallback simulation function
        async function simulateSmokingPrediction(data) {
            // Simulate API delay
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Simple heuristic-based prediction
            let riskFactors = 0;
            
            // Age factor
            if (data.age > 40) riskFactors += 1;
            
            // Blood pressure factor
            if (data.systolic > 140 || data.diastolic > 90) riskFactors += 2;
            
            // Cholesterol factor
            if (data.cholesterol > 240) riskFactors += 1;
            
            // HDL factor (low HDL is bad)
            if (data.hdl < 40) riskFactors += 1;
            
            // LDL factor
            if (data.ldl > 160) riskFactors += 1;
            
            // Liver enzyme factors
            if (data.ast > 40 || data.alt > 56) riskFactors += 2;
            
            // BMI factor
            const bmi = data.weight / ((data.height / 100) ** 2);
            if (bmi > 30) riskFactors += 1;
            
            // Blood sugar factor
            if (data.fasting_blood_sugar > 126) riskFactors += 2;
            
            // Calculate probability based on risk factors
            const maxRiskFactors = 11;
            const probability = Math.min(riskFactors / maxRiskFactors * 0.8 + Math.random() * 0.2, 0.95);
            const isSmoker = probability > 0.5;
            
            return {
                is_smoker: isSmoker,
                probability: probability,
                prediction: isSmoker ? 'Likely Smoker' : 'Likely Non-Smoker',
                confidence: Math.abs(probability - 0.5) * 2
            };
        }

        // Sample data functions
        function fillSampleData(type) {
            const form = document.getElementById('healthForm');
            let sampleData;
            
            if (type === 'healthy') {
                sampleData = {
                    age: 28,
                    height: 175,
                    weight: 70,
                    waist: 80,
                    systolic: 115,
                    diastolic: 75,
                    fasting_blood_sugar: 90,
                    cholesterol: 180,
                    hdl: 55,
                    ldl: 100,
                    ast: 25,
                    alt: 30
                };
            } else if (type === 'risk') {
                sampleData = {
                    age: 45,
                    height: 170,
                    weight: 85,
                    waist: 95,
                    systolic: 145,
                    diastolic: 95,
                    fasting_blood_sugar: 130,
                    cholesterol: 250,
                    hdl: 35,
                    ldl: 170,
                    ast: 55,
                    alt: 65
                };
            }
            
            Object.keys(sampleData).forEach(key => {
                const input = form.querySelector(`[name="${key}"]`);
                if (input) {
                    input.value = sampleData[key];
                }
            });
        }

        function clearForm() {
            document.getElementById('healthForm').reset();
            document.getElementById('analysisContent').innerHTML = `
                <div style="text-align: center; color: #718096; padding: 40px 20px;">
                    <h3>Health Analysis</h3>
                    <p>Enter your health data to see detailed analysis and recommendations</p>
                </div>
            `;
        }

        // Message handling functions
        function showMessage(message, type) {
            hideMessage();
            
            const messageDiv = document.createElement('div');
            messageDiv.id = 'messageDisplay';
            messageDiv.className = type === 'success' ? 'success-message' : 'error-message';
            messageDiv.textContent = message;
            
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.style.display = 'block';
            errorDiv.appendChild(messageDiv);
            
            // Auto-hide success messages after 5 seconds
            if (type === 'success') {
                setTimeout(() => {
                    hideMessage();
                }, 5000);
            }
        }

        function hideMessage() {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.style.display = 'none';
            errorDiv.innerHTML = '';
        }

        // Input validation
        document.addEventListener('DOMContentLoaded', function() {
            const inputs = document.querySelectorAll('.input-field');
            
            inputs.forEach(input => {
                input.addEventListener('input', function() {
                    validateInput(this);
                });
                
                input.addEventListener('blur', function() {
                    validateInput(this);
                });
            });
        });

        function validateInput(input) {
            const value = parseFloat(input.value);
            const min = parseFloat(input.min);
            const max = parseFloat(input.max);
            
            // Remove any existing validation styling
            input.style.borderColor = '';
            input.style.backgroundColor = '';
            
            if (input.value === '') {
                return; // Empty is handled by required attribute
            }
            
            if (isNaN(value) || value < min || value > max) {
                input.style.borderColor = '#f56565';
                input.style.backgroundColor = '#fed7d7';
            } else {
                input.style.borderColor = '#48bb78';
                input.style.backgroundColor = '#c6f6d5';
            }
        }

        // Form validation before submit
        function validateForm() {
            const form = document.getElementById('healthForm');
            const inputs = form.querySelectorAll('.input-field[required]');
            let isValid = true;
            
            inputs.forEach(input => {
                const value = parseFloat(input.value);
                const min = parseFloat(input.min);
                const max = parseFloat(input.max);
                
                if (input.value === '' || isNaN(value) || value < min || value > max) {
                    validateInput(input);
                    isValid = false;
                }
            });
            
            return isValid;
        }

        // Enhanced form submission with validation
        document.getElementById('healthForm').addEventListener('submit', function(e) {
            if (!validateForm()) {
                e.preventDefault();
                showMessage('Please check all input values are within the specified ranges.', 'error');
                return;
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + Enter to submit form
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                if (validateForm()) {
                    document.getElementById('healthForm').dispatchEvent(new Event('submit'));
                }
            }
            
            // Escape to clear form
            if (e.key === 'Escape') {
                clearForm();
            }
        });

        // Auto-save form data to prevent loss
        let formData = {};
        const inputs = document.querySelectorAll('.input-field');
        
        inputs.forEach(input => {
            input.addEventListener('input', function() {
                formData[this.name] = this.value;
                // Store in memory (not localStorage due to restrictions)
            });
        });

        // Restore form data on page load
        window.addEventListener('beforeunload', function(e) {
            // Could implement a warning if form has data
            const hasData = Object.values(formData).some(value => value !== '');
            if (hasData) {
                e.preventDefault();
                e.returnValue = '';
            }
        });

        // Performance monitoring
        let analysisStartTime;
        
        function startPerformanceMonitoring() {
            analysisStartTime = performance.now();
        }
        
        function endPerformanceMonitoring() {
            if (analysisStartTime) {
                const duration = performance.now() - analysisStartTime;
                console.log(`Analysis completed in ${duration.toFixed(2)}ms`);
            }
        }

        // Enhanced error handling
        window.addEventListener('error', function(e) {
            console.error('Global error:', e.error);
            showMessage('An unexpected error occurred. Please refresh the page and try again.', 'error');
        });

        window.addEventListener('unhandledrejection', function(e) {
            console.error('Unhandled promise rejection:', e.reason);
            showMessage('A network or processing error occurred. Please check your connection and try again.', 'error');
        });

        // Initialize tooltips and help text
        document.addEventListener('DOMContentLoaded', function() {
            // Add hover effects to metric cards
            const metricCards = document.querySelectorAll('.metric-card');
            metricCards.forEach(card => {
                card.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-2px)';
                    this.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
                });
                
                card.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0)';
                    this.style.boxShadow = 'none';
                });
            });
        });

        // Accessibility enhancements
        document.addEventListener('DOMContentLoaded', function() {
            // Add ARIA labels
            const form = document.getElementById('healthForm');
            form.setAttribute('aria-label', 'Health data input form');
            
            const analysisSection = document.getElementById('analysisContent');
            analysisSection.setAttribute('aria-label', 'Health analysis results');
            
            // Add focus management
            const firstInput = form.querySelector('.input-field');
            if (firstInput) {
                firstInput.focus();
            }
        });

        // Print functionality
        function printResults() {
            const printWindow = window.open('', '_blank');
            const analysisContent = document.getElementById('analysisContent').innerHTML;
            
            printWindow.document.write(`
                <html>
                <head>
                    <title>SmokeSense Pro - Health Analysis Results</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .metric-card { border: 1px solid #ccc; padding: 10px; margin: 10px 0; }
                        .excellent { color: #48bb78; }
                        .good { color: #38a169; }
                        .fair { color: #ed8936; }
                        .poor { color: #f56565; }
                    </style>
                </head>
                <body>
                    <h1>SmokeSense Pro - Health Analysis Results</h1>
                    <p>Generated on: ${new Date().toLocaleDateString()}</p>
                    ${analysisContent}
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.print();
        }

        // Export functionality
        function exportResults() {
            const analysisText = document.getElementById('analysisContent').innerText;
            const blob = new Blob([analysisText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `health-analysis-${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>